{% extends 'base.html' %}

{% block title %}Processing PDFs{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Processing Your PDFs</h2>
    
    <div class="progress mb-4">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
            role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    
    <div id="status-message" class="alert alert-info text-center">
        Starting PDF processing...
    </div>
    
    <div class="card">
        <div class="card-header">
            Processing Steps
        </div>
        <ul class="list-group list-group-flush" id="processing-steps">
            <li class="list-group-item d-flex justify-content-between align-items-center" id="step-upload">
                Uploading files
                <span class="badge badge-secondary">Waiting</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" id="step-extract">
                Extracting PDF content
                <span class="badge badge-secondary">Waiting</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" id="step-compare_text">
                Comparing content
                <span class="badge badge-secondary">Waiting</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" id="step-analyze">
                AI analysis of differences
                <span class="badge badge-secondary">Waiting</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" id="step-render">
                Rendering results
                <span class="badge badge-secondary">Waiting</span>
            </li>
        </ul>
    </div>
</div>

<script>
    // Get session ID from URL
    const sessionId = '{{ session_id }}';
    
    // Set initial steps as completed
    updateStepStatus('upload', 'completed');
    
    // Poll for processing status
    function pollStatus() {
        fetch(`/check_processing_status/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = `${data.progress}%`;
                progressBar.innerText = `${data.progress}%`;
                progressBar.setAttribute('aria-valuenow', data.progress);
                
                // Update status message
                document.getElementById('status-message').innerText = data.message;
                
                // Map backend steps to our simplified frontend steps
                let currentStep = data.step;
                if (currentStep === 'save') {
                    currentStep = 'upload';
                } else if (currentStep === 'compare_images') {
                    currentStep = 'compare_text';
                } else if (currentStep === 'prepare_output') {
                    currentStep = 'render';
                }
                
                // Update step status
                updateStepStatus(currentStep, 'processing');
                
                // Handle completion
                if (data.status === 'completed') {
                    updateStepStatus('render', 'completed');
                    window.location.href = data.redirect;
                    return;
                }
                
                // Handle error
                if (data.status === 'error') {
                    document.getElementById('status-message').className = 'alert alert-danger text-center';
                    document.getElementById('status-message').innerText = data.message;
                    return;
                }
                
                // Continue polling
                setTimeout(pollStatus, 500);
            })
            .catch(error => {
                console.error('Error checking processing status:', error);
                document.getElementById('status-message').className = 'alert alert-danger text-center';
                document.getElementById('status-message').innerText = 'Error checking processing status';
                setTimeout(pollStatus, 2000);
            });
    }
    
    // Mark previous steps as completed
    function updateStepStatus(currentStep, status) {
        const steps = ['upload', 'extract', 'compare_text', 'analyze', 'render'];
        const stepIndex = steps.indexOf(currentStep);
        
        if (stepIndex === -1) return;
        
        // Update current step
        const currentStepElement = document.getElementById(`step-${currentStep}`);
        if (!currentStepElement) return;
        
        const currentBadge = currentStepElement.querySelector('.badge');
        if (status === 'processing') {
            currentStepElement.classList.add('active');
            currentBadge.className = 'badge badge-primary';
            currentBadge.innerText = 'In Progress';
        } else if (status === 'completed') {
            currentStepElement.classList.remove('active');
            currentBadge.className = 'badge badge-success';
            currentBadge.innerText = 'Completed';
        }
        
        // Update previous steps as completed
        for (let i = 0; i < stepIndex; i++) {
            const prevStep = document.getElementById(`step-${steps[i]}`);
            if (!prevStep) continue;
            
            const prevBadge = prevStep.querySelector('.badge');
            prevStep.classList.remove('active');
            prevBadge.className = 'badge badge-success';
            prevBadge.innerText = 'Completed';
        }
    }
    
    // Start polling when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Set first step as completed
        updateStepStatus('upload', 'completed');
        
        // Start processing
        fetch(`/process_pdfs/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    pollStatus();
                } else {
                    document.getElementById('status-message').className = 'alert alert-danger text-center';
                    document.getElementById('status-message').innerText = data.message;
                }
            })
            .catch(error => {
                console.error('Error starting PDF processing:', error);
                document.getElementById('status-message').className = 'alert alert-danger text-center';
                document.getElementById('status-message').innerText = 'Error starting PDF processing';
            });
    });
</script>
{% endblock %} 